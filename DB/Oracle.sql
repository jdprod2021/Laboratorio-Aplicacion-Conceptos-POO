-- ============ ENTIDADES (idempotente) ===========

BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE PERSONA (
      id         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      nombres    VARCHAR2(100) NOT NULL,
      apellidos  VARCHAR2(100) NOT NULL,
      email      VARCHAR2(120),
      CONSTRAINT uq_persona_email UNIQUE (email)
    )
  ';
EXCEPTION
  WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE PROFESOR (
      id              NUMBER PRIMARY KEY,
      tipo_contrato   VARCHAR2(50) NOT NULL,
      CONSTRAINT fk_profesor_persona
        FOREIGN KEY (id) REFERENCES PERSONA(id) ON DELETE CASCADE
    )
  ';
EXCEPTION
  WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE FACULTAD (
      id         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      nombre     VARCHAR2(120) NOT NULL,
      decano_id  NUMBER,
      CONSTRAINT fk_facultad_decano
        FOREIGN KEY (decano_id) REFERENCES PERSONA(id)
    )
  ';
EXCEPTION
  WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE PROGRAMA (
      id          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      nombre      VARCHAR2(120) NOT NULL,
      duracion    NUMBER,
      registro    DATE,
      facultad_id NUMBER NOT NULL,
      CONSTRAINT fk_programa_facultad
        FOREIGN KEY (facultad_id) REFERENCES FACULTAD(id)
    )
  ';
EXCEPTION
  WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE CURSO (
      id          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      nombre      VARCHAR2(120) NOT NULL,
      programa_id NUMBER NOT NULL,
      activo      NUMBER(1) DEFAULT 1 NOT NULL,
      CONSTRAINT fk_curso_programa
        FOREIGN KEY (programa_id) REFERENCES PROGRAMA(id)
    )
  ';
EXCEPTION
  WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE ESTUDIANTE (
      id          NUMBER PRIMARY KEY,
      codigo      NUMBER,
      programa_id NUMBER,
      activo      NUMBER(1) DEFAULT 1 NOT NULL,
      promedio    NUMBER,
      CONSTRAINT fk_estudiante_persona
        FOREIGN KEY (id) REFERENCES PERSONA(id) ON DELETE CASCADE,
      CONSTRAINT fk_estudiante_programa
        FOREIGN KEY (programa_id) REFERENCES PROGRAMA(id) ON DELETE SET NULL,
      CONSTRAINT uq_estudiante_codigo UNIQUE (codigo)
    )
  ';
EXCEPTION
  WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE INSCRIPCION (
      id            NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      curso_id      NUMBER NOT NULL,
      anio          NUMBER NOT NULL,
      semestre      NUMBER NOT NULL CHECK (semestre IN (1, 2)),
      estudiante_id NUMBER NOT NULL,
      CONSTRAINT fk_insc_curso
        FOREIGN KEY (curso_id) REFERENCES CURSO(id),
      CONSTRAINT fk_insc_estudiante
        FOREIGN KEY (estudiante_id) REFERENCES ESTUDIANTE(id) ON DELETE CASCADE,
      CONSTRAINT uq_insc_unique UNIQUE (curso_id, anio, semestre, estudiante_id)
    )
  ';
EXCEPTION
  WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE CURSO_PROFESOR (
      profesor_id  NUMBER NOT NULL,
      curso_id     NUMBER NOT NULL,
      anio         NUMBER NOT NULL,
      semestre     NUMBER NOT NULL CHECK (semestre IN (1, 2)),
      CONSTRAINT pk_cp PRIMARY KEY (profesor_id, anio, semestre, curso_id),
      CONSTRAINT fk_cp_profesor FOREIGN KEY (profesor_id) REFERENCES PROFESOR(id),
      CONSTRAINT fk_cp_curso    FOREIGN KEY (curso_id)    REFERENCES CURSO(id)
    )
  ';
EXCEPTION
  WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF;
END;
/
